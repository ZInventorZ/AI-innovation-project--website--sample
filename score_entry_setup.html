<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>New Score</title>
  <link rel="stylesheet" href="style.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
</head>
<body>
<!-- Top-left back button: tries history.back(), falls back to index.html -->
<a class="back-btn" href="index.html" onclick="if(history.length>1){history.back();return false;}">‚Üê Back</a>
<header class="page-header"><div class="container"><h1>New Score</h1></div></header>
<nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-bottom">
  <div class="container-fluid">
    <a class="navbar-brand" href="index.html">AI Innovation</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="nav nav-pills ms-auto">
        <li class="nav-item"><a class="nav-link" href="index.html"><span class="nav-icon">üìà</span>History</a></li>
        <li class="nav-item"><a class="nav-link" href="AI_Coach.html"><span class="nav-icon">ü§ñ</span>AI Coach</a></li>
        <li class="nav-item"><a class="nav-link" href="equipment.html"><span class="nav-icon">üèπ</span>Equipment</a></li>
        <li class="nav-item"><a class="nav-link" href="Scores.html"><span class="nav-icon">üìä</span>Statistics</a></li>
        <li class="nav-item"><a class="nav-link" href="index.html"><span class="nav-icon">üìà</span>History</a></li>
        <li class="nav-item"><a class="nav-link" href="profile_edit.html"><span class="nav-icon">üë§</span>Profile</a></li>
      </ul>
    </div>
  </div>
</nav>

<main class="site-main container py-4">
  <div class="card p-3">
    <label class="form-label">Round Style</label>
    <select id="roundStyle" class="form-select mb-3">
      <option value="generic">Generic Practice</option>
      <option value="vegas">Vegas</option>
      <option value="nfaa">NFAA</option>
      <option value="3d">3D Shoot (score only)</option>
    </select>

    <!-- Vegas Round Options -->
    <div id="vegasOptions" style="display:none;" class="mb-3 p-3 bg-light rounded">
      <label class="form-label">Vegas Format</label>
      <div class="row g-2 mb-3">
        <div class="col-6">
          <select id="vegasFormat" class="form-select">
            <option value="single">Single Face</option>
            <option value="triple">Triple Face</option>
          </select>
        </div>
        <div class="col-6">
          <input id="vegasMaxScore" type="number" class="form-control" placeholder="Max score (e.g., 300, 450)" value="300">
        </div>
      </div>
    </div>

    <!-- NFAA Round Options -->
    <div id="nfaaOptions" style="display:none;" class="mb-3 p-3 bg-light rounded">
      <label class="form-label">NFAA Option</label>
      <div class="row g-2">
        <div class="col-12">
          <select id="nfaaType" class="form-select">
            <option value="5spot">5-Spot</option>
            <option value="single">Single Face</option>
          </select>
        </div>
      </div>
    </div>

    <!-- Target Image Display -->
    <div id="targetImageContainer" class="mb-3" style="text-align:center;display:none;">
      <img id="targetImage" src="" alt="Target" style="max-width:200px;max-height:200px;border-radius:0.4rem;box-shadow:0 1px 3px rgba(0,0,0,0.1);">
    </div>

    <div id="roundFields">
        <div class="row g-2">
        <div class="col-md-6">
          <label class="form-label">Practice Name (choose template)</label>
          <div class="d-flex gap-2">
            <select id="name" class="form-select"></select>
            <button id="btnAddTemplate" type="button" class="btn btn-outline-secondary">Save</button>
            <button id="btnClearTemplates" type="button" class="btn btn-outline-danger">Clear</button>
          </div>
        </div>
        <div class="col-12">
          <label class="form-label">Distances (add multiple distances or use the single Distance/Ends fields below)</label>
          <div id="distances" class="mb-2"></div>
          <button id="addDistance" type="button" class="btn btn-sm btn-outline-primary">+ Add distance</button>
        </div>
        <div class="col-md-3"><label class="form-label">Arrows per end</label><input id="arrowCount" type="number" class="form-control"></div>
        <div class="col-md-3"><label class="form-label">Ends</label><input id="ends" type="number" class="form-control"></div>
        <div class="col-md-4"><label class="form-label">Distance (m)</label><input id="distance" type="number" class="form-control"></div>
        <div class="col-md-4"><label class="form-label">Organization</label>
          <select id="organization" class="form-select">
            <option value="">(none)</option>
            <option value="ASA">ASA</option>
            <option value="NFAA">NFAA</option>
            <option value="Other">Other</option>
          </select>
        </div>
        <div class="col-md-4"><label class="form-label">Target Face</label>
          <select id="targetFace" class="form-select">
            <option value="standard">Standard</option>
            <option value="blue">Blue-faced (NFAA)</option>
          </select>
        </div>
        <div class="col-md-4"><label class="form-label">Total Score (optional)</label><input id="totalScore" type="number" class="form-control"></div>
        <div class="col-md-4"><label class="form-label">Notes</label><input id="notes" class="form-control"></div>
        <div class="col-md-4">
          <label class="form-label">Weather</label>
          <div class="d-flex gap-2">
            <select id="weather" class="form-select">
              <option value="indoor">Indoor</option>
              <option value="outdoor">Outdoor</option>
            </select>
            <button id="pullWeather" type="button" class="btn btn-outline-secondary">Pull</button>
          </div>
        </div>
        <div class="col-md-4">
          <label class="form-label">Equipment Setup</label>
          <select id="equipmentSetup" class="form-select">
            <option value="">(none)</option>
          </select>
        </div>
      </div>
    </div>

    <!-- Scan scoresheet -->
    <div class="card mt-3 p-3">
      <h5 class="mb-2">Scan Scoresheet</h5>
      <div class="d-flex gap-2 align-items-center">
        <input id="scanFile" type="file" accept="image/*,application/pdf" class="form-control w-auto">
        <button id="takePhoto" type="button" class="btn btn-outline-secondary">Take picture</button>
        <button id="scanTarget" type="button" class="btn btn-outline-secondary">Scan target</button>
        <div id="scanStatus" class="ms-2 text-muted">No file selected</div>
      </div>
    </div>

    <!-- Session equipment details -->
    <div class="card mt-3 p-3">
      <h5 class="mb-2">Session Equipment Details</h5>
      <div class="row g-2">
        <div class="col-md-6"><label class="form-label">Bow</label><input id="session_bow" class="form-control"></div>
        <div class="col-md-6"><label class="form-label">Sight - Pin count</label><input id="session_sight_pins" type="number" class="form-control"></div>
        <div class="col-md-6"><label class="form-label">Sight - Type</label>
          <select id="session_sight_type" class="form-select"><option value="slider">Slider</option><option value="fixed">Fixed</option></select>
        </div>
        <div class="col-md-6"><label class="form-label">Arrow Model</label><input id="session_arrow_model" class="form-control"></div>
        <div class="col-md-4"><label class="form-label">Vanes</label><input id="session_arrow_vanes" class="form-control" placeholder="e.g., 4 AirRazer"></div>
        <div class="col-md-4"><label class="form-label">Spine</label><input id="session_arrow_spine" class="form-control" placeholder="e.g., 300"></div>
        <div class="col-md-4"><label class="form-label">Diameter</label><input id="session_arrow_diameter" class="form-control" placeholder="e.g., 25"></div>
      </div>
      <div class="mt-2"><button id="fillVictory" class="btn btn-sm btn-secondary">Fill Victory V-TAC</button></div>
    </div>

    <div class="mt-3">
      <button id="save" class="btn btn-primary">Save Round</button>
      <a href="practice_list.html" class="btn btn-link">View Practices</a>
    </div>
  </div>
</main>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
(function(){
  function getPractices(){return JSON.parse(localStorage.getItem('practices')||'[]');}
  function savePractices(arr){localStorage.setItem('practices',JSON.stringify(arr));}
  function getTemplates(){return JSON.parse(localStorage.getItem('practiceTemplates')||'[]');}
  function saveTemplates(arr){localStorage.setItem('practiceTemplates',JSON.stringify(arr));}
  
  const style = document.getElementById('roundStyle');
  const vegasOptions = document.getElementById('vegasOptions');
  const nfaaOptions = document.getElementById('nfaaOptions');
  const vegasFormat = document.getElementById('vegasFormat');
  const vegasMaxScore = document.getElementById('vegasMaxScore');
  const nfaaType = document.getElementById('nfaaType');

  const map = {
    vegas: { ends: 10, arrowCount: 3, name: 'Vegas' },
    nfaa: { ends: 6, arrowCount: 5, name: 'NFAA 5-Spot' },
    '3d': { ends: 0, arrowCount: 0, name: '3D Shoot' },
    generic: { ends: 6, arrowCount: 6, name: 'Practice' }
  };

  function updateRoundName(){
    if(style.value === 'vegas'){
      const maxScore = vegasMaxScore.value || '300';
      document.getElementById('name').value = `Vegas ${maxScore}`;
    } else if(style.value === 'nfaa'){
      const type = nfaaType.value === '5spot' ? '5-Spot' : 'Single';
      document.getElementById('name').value = `NFAA ${type}`;
    } else {
      const p = map[style.value] || map.generic;
      document.getElementById('name').value = p.name;
    }
  }

  function applyPreset(){
    const v = style.value;
    vegasOptions.style.display = (v === 'vegas') ? 'block' : 'none';
    nfaaOptions.style.display = (v === 'nfaa') ? 'block' : 'none';

    const p = map[v] || map.generic;
    if(p.ends > 0){
      document.getElementById('ends').value = p.ends;
      document.getElementById('arrowCount').value = p.arrowCount;
    } else {
      document.getElementById('ends').value = '';
      document.getElementById('arrowCount').value = '';
    }

    if(v === '3d'){
      document.getElementById('totalScore').placeholder = 'Enter total points (no arrows)';
    } else {
      document.getElementById('totalScore').placeholder = 'leave blank to estimate';
    }
    
    // Display target image based on round style
    const targetContainer = document.getElementById('targetImageContainer');
    const targetImage = document.getElementById('targetImage');
    const targetImages = {
      nfaa: 'images/Target_images/NFAA_single.jpg',
      '3d': 'images/Target_images/ASA_3D.png'
    };
    
    if(targetImages[v]){
      targetImage.src = targetImages[v];
      targetContainer.style.display = 'block';
    } else {
      targetContainer.style.display = 'none';
    }

    updateRoundName();
  }

  style.addEventListener('change', applyPreset);
  vegasFormat.addEventListener('change', updateRoundName);
  vegasMaxScore.addEventListener('change', updateRoundName);
  nfaaType.addEventListener('change', updateRoundName);
  
  applyPreset();

  // Templates and multi-distance helpers
  const tplSelect = document.getElementById('name');
  function populateTemplates(){ tplSelect.innerHTML=''; const opt0=document.createElement('option'); opt0.value=''; opt0.textContent='(new / none)'; tplSelect.appendChild(opt0); const tpls = getTemplates(); tpls.forEach(t=>{ const o=document.createElement('option'); o.value=t.id; o.textContent=t.name; tplSelect.appendChild(o); }); }

  const distancesEl = document.getElementById('distances');
  function addDistanceRow(d){ const div=document.createElement('div'); div.className='d-flex gap-2 align-items-center mb-2'; div.innerHTML = `<input class="form-control form-control-sm" type="number" placeholder="Distance (m)" value="${d?.distance||18}" style="width:110px"><input class="form-control form-control-sm" type="number" placeholder="Ends" value="${d?.ends||1}" style="width:90px"><input class="form-control form-control-sm" type="number" placeholder="Arrows/end" value="${d?.arrowsPerEnd||3}" style="width:110px"><button class="btn btn-sm btn-outline-danger">Remove</button>`; div.querySelector('button').addEventListener('click',()=>div.remove()); distancesEl.appendChild(div); }
  document.getElementById('addDistance').addEventListener('click',()=> addDistanceRow());

  tplSelect.addEventListener('change', function(){ const id=this.value; if(!id){ distancesEl.innerHTML=''; return; } const t = getTemplates().find(x=>String(x.id)===String(id)); if(!t) return; distancesEl.innerHTML=''; (t.distances||[]).forEach(d=>addDistanceRow(d)); document.getElementById('weather').value = t.weather || 'indoor'; document.getElementById('equipmentSetup').value = t.equipmentSetupId || ''; document.getElementById('distance').value=''; document.getElementById('arrowCount').value=''; document.getElementById('ends').value=''; });

  document.getElementById('btnAddTemplate').addEventListener('click', ()=>{
    const name = prompt('Template name:'); if(!name) return; const tpl = { id: Date.now(), name, distances: [], weather: document.getElementById('weather').value, equipmentSetupId: document.getElementById('equipmentSetup').value || '' };
    document.querySelectorAll('#distances > div').forEach(div=>{ const inputs=div.querySelectorAll('input'); tpl.distances.push({ distance: Number(inputs[0].value)||0, ends: Number(inputs[1].value)||0, arrowsPerEnd: Number(inputs[2].value)||0 }); });
    const arr = getTemplates(); arr.unshift(tpl); saveTemplates(arr); populateTemplates(); document.getElementById('m_status') && (document.getElementById('m_status').textContent='Template saved ‚úì'); setTimeout(()=>{ document.getElementById('m_status') && (document.getElementById('m_status').textContent=''); },1500);
  });

  document.getElementById('btnClearTemplates').addEventListener('click', ()=>{ if(!confirm('Clear saved templates?')) return; saveTemplates([]); populateTemplates(); document.getElementById('m_status') && (document.getElementById('m_status').textContent='Templates cleared'); setTimeout(()=>{ document.getElementById('m_status') && (document.getElementById('m_status').textContent=''); },1500); });

  populateTemplates();

  document.getElementById('save').addEventListener('click',function(e){
    e.preventDefault();
    const p = { id:Date.now(), name: (document.getElementById('name').selectedOptions ? (document.getElementById('name').selectedOptions[0].textContent||'') : document.getElementById('name').value) || map[style.value].name, distances: null, endCount: 0, arrowCount:0, ends:0, distance:0, totalScore:(function(){const v=document.getElementById('totalScore').value; return v!==''?Number(v):null})(), notes:document.getElementById('notes').value||'', weather: document.getElementById('weather')? document.getElementById('weather').value : null, equipmentSetupId: (function(){const v=document.getElementById('equipmentSetup')?.value; return v? Number(v): null})(), equipmentSetup: null, sessionEquipment: { bow: document.getElementById('session_bow')?document.getElementById('session_bow').value:null, sight: { pins: Number(document.getElementById('session_sight_pins')?.value)||0, type: document.getElementById('session_sight_type')?.value||null }, arrow: { model: document.getElementById('session_arrow_model')?.value||null, vanes: document.getElementById('session_arrow_vanes')?.value||null, spine: document.getElementById('session_arrow_spine')?.value||null, diameter: document.getElementById('session_arrow_diameter')?.value||null } }, created:new Date().toISOString(), organization: (document.getElementById('organization')?.value) || null, targetFace: (document.getElementById('targetFace')?.value) || null };
    const rows = document.querySelectorAll('#distances > div');
    if(rows && rows.length){ p.distances = []; rows.forEach(div=>{ const inputs = div.querySelectorAll('input'); p.distances.push({ distance: Number(inputs[0].value)||0, ends: Number(inputs[1].value)||0, arrowsPerEnd: Number(inputs[2].value)||0 }); });
      let totalArrows=0; p.distances.forEach(d=> totalArrows += (d.ends||0)*(d.arrowsPerEnd||0)); p.totalArrows = totalArrows; }
    else {
      p.endCount = Number(document.getElementById('arrowCount').value)||0;
      p.arrowCount = Number(document.getElementById('arrowCount').value)||0;
      p.ends = Number(document.getElementById('ends').value)||0;
      p.distance = Number(document.getElementById('distance').value)||0;
    }
    function totalArrows(obj){const perEnd = Number(obj.endCount) || Number(obj.arrowCount) || 0; const ends = Number(obj.ends) || 1; return perEnd * ends;}
    if(p.totalScore==null){
      const practices=getPractices(); let sumScore=0,sumArrows=0; practices.forEach(pr=>{ if(pr.totalScore!=null){ const arrows = totalArrows(pr); if(arrows>0){ sumScore+=Number(pr.totalScore); sumArrows+=arrows }}});
      const avgPerArrow = sumArrows>0? (sumScore/sumArrows):8.0; const arrowsNow = totalArrows(p);
      p.totalScore = arrowsNow>0? Math.round(avgPerArrow*arrowsNow): (style.value==='3d'? 0:0);
    }
    const arr=getPractices(); arr.push(p); savePractices(arr);
    window.location.href='practice_detail.html?id='+p.id;
  });
  
  (function(){
    const sel=document.getElementById('equipmentSetup');
    const arr = JSON.parse(localStorage.getItem('equipmentSetups')||'[]');
    arr.forEach(s=>{ const opt=document.createElement('option'); opt.value=s.id; opt.textContent=s.name; sel.appendChild(opt); });
    const saveBtn = document.getElementById('save');
    saveBtn.addEventListener('click', ()=>{
      const setups = JSON.parse(localStorage.getItem('equipmentSetups')||'[]');
      const list = JSON.parse(localStorage.getItem('practices')||'[]');
      if(!list.length) return;
      const last = list[list.length-1];
      const selId = Number(document.getElementById('equipmentSetup')?.value) || null;
      if(selId){ const s = setups.find(x=>x.id===selId); if(s){ last.equipmentSetup = s; list[list.length-1]=last; localStorage.setItem('practices',JSON.stringify(list)); }}
    });
  })();

  document.getElementById('pullWeather').addEventListener('click',()=>{
    const mdl = document.createElement('div'); mdl.innerHTML = '<div class="modal fade" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Not available</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body">Pulling weather from location/time is not yet available.</div><div class="modal-footer"><button class="btn btn-secondary" data-bs-dismiss="modal">Close</button></div></div></div></div>';
    document.body.appendChild(mdl);
    const bsModal = new bootstrap.Modal(mdl.querySelector('.modal'));
    bsModal.show();
    mdl.querySelector('.modal').addEventListener('hidden.bs.modal', ()=> mdl.remove());
  });

  const scanFile = document.getElementById('scanFile');
  const scanStatus = document.getElementById('scanStatus');
  scanFile.addEventListener('change', (ev)=>{ const f = ev.target.files && ev.target.files[0]; if(f) scanStatus.textContent = f.name; else scanStatus.textContent='No file selected'; });
  
  document.getElementById('takePhoto').addEventListener('click', ()=>{
    const mdl = document.createElement('div'); mdl.innerHTML = '<div class="modal fade" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Camera</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body">Camera not functional at this time.</div><div class="modal-footer"><button class="btn btn-secondary" data-bs-dismiss="modal">Close</button></div></div></div></div>';
    document.body.appendChild(mdl);
    const bsModal = new bootstrap.Modal(mdl.querySelector('.modal'));
    bsModal.show();
    mdl.querySelector('.modal').addEventListener('hidden.bs.modal', ()=> mdl.remove());
  });

  const scanTargetBtn = document.getElementById('scanTarget');
  if(scanTargetBtn){
    scanTargetBtn.addEventListener('click', ()=>{
      const mdl = document.createElement('div'); mdl.innerHTML = '<div class="modal fade" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Target Scan</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body">Target scanning is not available in this demo. Upload an image or use the camera in a real environment.</div><div class="modal-footer"><button class="btn btn-secondary" data-bs-dismiss="modal">Close</button></div></div></div></div>';
      document.body.appendChild(mdl);
      const bsModal = new bootstrap.Modal(mdl.querySelector('.modal'));
      bsModal.show();
      mdl.querySelector('.modal').addEventListener('hidden.bs.modal', ()=> mdl.remove());
    });
  }

  document.getElementById('fillVictory').addEventListener('click', ()=>{
    document.getElementById('session_bow').value = 'My Bow';
    document.getElementById('session_sight_pins').value = 3;
    document.getElementById('session_sight_type').value = 'slider';
    document.getElementById('session_arrow_model').value = 'Victory V-TAC';
    document.getElementById('session_arrow_vanes').value = '4 AirRazer vanes';
    document.getElementById('session_arrow_spine').value = '300';
    document.getElementById('session_arrow_diameter').value = '25';
  });
})();
</script>
</body>
</html>
