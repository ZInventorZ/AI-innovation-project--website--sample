<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>AI Innovation Project - History</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
    <link rel="icon" href="images/AIchery_logo.png" type="image/png">

    <style>
        /* Mini-dashboard strip */
        .mini-dashboard { display:flex; justify-content:space-around; margin-bottom:1rem; background:#f8f9fa; padding:0.5rem 1rem; border-radius:8px; box-shadow:0 1px 3px rgba(0,0,0,0.1); }
        .mini-dashboard div { text-align:center; font-size:0.9rem; }
        /* Session cards */
        .session-card { display:flex; background:#fff; margin-bottom:1rem; border-radius:8px; box-shadow:0 1px 4px rgba(0,0,0,0.1); cursor:pointer; transition: transform 0.1s; position:relative; }
        .session-card:hover { transform: translateY(-2px); }
        .left-stripe { width:8px; border-top-left-radius:8px; border-bottom-left-radius:8px; }
        .stripe-gray { background:#6c757d; }
        .stripe-yellow { background:#ffc107; }
        .stripe-blue { background:#0d6efd; }
        .content { flex:1; padding:0.75rem 1rem; }
        .score-title { font-weight:600; margin-bottom:0.3rem; }
        .score { font-weight:700; padding:0.75rem; min-width:60px; text-align:center; }
        .pb-badge { background:#198754; color:#fff; font-size:0.75rem; padding:2px 6px; border-radius:4px; margin-left:4px; }
        .target-dot { display:inline-block; width:12px; height:12px; border-radius:50%; margin-right:0.5rem; vertical-align:middle; }
        .target-dot.green { background:#28a745; }
        .target-dot.yellow { background:#ffc107; }
        .target-dot.red { background:#dc3545; }
        .pill.active { background:#0d6efd; color:#fff; }

        /* Splash screen */
        #splashScreen {
            position:fixed;
            top:0; left:0;
            width:100%; height:100%;
            background:#fff;
            display:flex;
            align-items:center;
            justify-content:center;
            flex-direction:column;
            z-index:9999;
            opacity:1;
            transition: opacity 0.6s ease;
        }
        #splashScreen img {
            max-width:200px;
            height:auto;
        }
        #splashScreen p {
            margin-top:1rem;
            font-size:1.2rem;
            color:#555;
        }
    </style>
</head>
<body>

    <!-- Splash Screen -->
    <div id="splashScreen">
        <img src="images/AIchery_logo_full_sized.png" alt="AIchery Logo">
        <p>Loading history...</p>
    </div>

    <!-- Back button -->
    <a class="back-btn" href="index.html" onclick="if(history.length>1){history.back();return false;}">‚Üê Back</a>

    <!-- Header -->
    <header class="page-header container py-2">
        <div class="d-flex align-items-center gap-3">
            <img src="images/AIchery_logo_full_sized.png" alt="AIchery Logo" style="max-width: 150px; height: auto;">
            <h1 class="m-0">History</h1>
        </div>
    </header>

    <main class="site-main container py-3">
        <!-- Mini-dashboard -->
        <div class="mini-dashboard" id="miniDashboard">
            <div>Avg Score: <span id="avgScore">‚Äî</span></div>
            <div>Best: <span id="bestScore">‚Äî</span></div>
            <div>Total Sessions: <span id="totalSessions">0</span></div>
        </div>

        <!-- Filters -->
        <div class="sessions-header mb-2">
            <div class="d-flex gap-2 flex-wrap">
                <button id="pillRounds" class="pill active" type="button">All Rounds</button>
                <button id="pillBows" class="pill" type="button">All Bows</button>
                <button id="pillSort" class="pill" type="button">Sort: Date</button>
            </div>
            <div id="pillMenuContainer" style="display:none;margin-top:.5rem"></div>
            <div class="result-count mt-2">0 Results</div>
        </div>

        <!-- Scores -->
        <div id="scores"></div>
    </main>

    <!-- Floating Action Button -->
    <a class="fab" href="score_entry_setup.html" title="New Practice">+</a>

    <!-- Bottom Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-bottom">
        <div class="container-fluid">
            <ul class="nav nav-pills ms-auto w-100 justify-content-around">
                <li class="nav-item"><a class="nav-link active" href="index.html">üìà History</a></li>
                <li class="nav-item"><a class="nav-link" href="AI_Coach.html">ü§ñ AI Coach</a></li>
                <li class="nav-item"><a class="nav-link" href="equipment.html">üèπ Equipment</a></li>
                <li class="nav-item"><a class="nav-link" href="statistics.html">üìä Statistics</a></li>
                <li class="nav-item"><a class="nav-link" href="competition.html">üèÜ Competition</a></li>
                <li class="nav-item"><a class="nav-link" href="menu.html">‚ò∞ Menu</a></li>
            </ul>
        </div>
    </nav>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
    (function(){
        // Splash fade
        const splash = document.getElementById('splashScreen');

        // Helper: get stored practices
        function getPractices(){ return JSON.parse(localStorage.getItem('practices')||'[]'); }

        // Seed fake data if none
        function seedFakeData(){
            const existing = getPractices();
            if(existing.length) return;
            const now = Date.now();
            const samples = [
                { id: now-1, name:'Vegas 300', endCount:3, arrowCount:3, ends:10, distance:18, totalScore:270, notes:'Evening indoor', created:new Date(now-1000*60*60*24*5).toISOString(), sessionEquipment:{bow:'EliteX', sight:{pins:3,type:'slider'}} },
                { id: now-2, name:'Practice - 50m', endCount:6, arrowCount:6, ends:6, distance:50, totalScore:312, notes:'Outdoor windy', created:new Date(now-1000*60*60*24*12).toISOString(), sessionEquipment:{bow:'LongShot', sight:{pins:5,type:'fixed'}} },
                { id: now-3, name:'Short Range', endCount:3, arrowCount:3, ends:8, distance:18, totalScore:204, notes:'Quick drill', created:new Date(now-1000*60*60*24*2).toISOString(), sessionEquipment:{bow:'My Bow', sight:{pins:3,type:'slider'}} },
                { id: now-4, name:'3D Shoot', endCount:0, arrowCount:0, ends:0, distance:0, totalScore:85, notes:'3D course', created:new Date(now-1000*60*60*24*30).toISOString() },
                { id: now-5, name:'Practice - indoor', endCount:6, arrowCount:6, ends:4, distance:25, totalScore:160, notes:'Practice', created:new Date(now-1000*60*60*24*1).toISOString() }
            ];
            localStorage.setItem('practices', JSON.stringify(samples));
        }
        seedFakeData();

        function totalArrows(p){ return Number(p.endCount || p.arrowCount || 0) * Number(p.ends || 1); }

        // Render scores
        function renderScores(){
            const list = getPractices();
            const container = document.getElementById('scores');
            container.innerHTML = '';
            if(!list.length){ container.innerHTML='<div class="alert alert-secondary">No history yet.</div>'; document.querySelector('.result-count').textContent='0 Results'; return; }

            const scored = list.filter(p=>p.totalScore!=null);
            const pb = scored.length ? Math.max(...scored.map(p=>p.totalScore)) : null;

            // Mini-dashboard
            document.getElementById('avgScore').textContent = scored.length ? Math.round(scored.reduce((a,b)=>a+b.totalScore,0)/scored.length) : '‚Äî';
            document.getElementById('bestScore').textContent = pb||'‚Äî';
            document.getElementById('totalSessions').textContent = list.length;

            // Filtered & sorted
            let filtered = list.slice().reverse().filter(p=>{
                if(state.round && state.round!==''){
                    if(!p.name || p.name.toLowerCase().indexOf(state.round.toLowerCase())===-1) return false;
                }
                if(state.bow && state.bow!==''){
                    const bow = (p.equipmentSetup&&p.equipmentSetup.bow)||(p.sessionEquipment&&p.sessionEquipment.bow)||'';
                    if(!bow || bow.toLowerCase().indexOf(state.bow.toLowerCase())===-1) return false;
                }
                return true;
            });

            if(state.sort==='dateAsc') filtered.sort((a,b)=>new Date(a.created)-new Date(b.created));
            else if(state.sort==='avgDesc') filtered.sort((a,b)=>{
                const avgA = (a.totalScore/totalArrows(a))||0;
                const avgB = (b.totalScore/totalArrows(b))||0;
                return avgB-avgA;
            });

            filtered.forEach(p=>{
                const total = p.totalScore;
                const arrows = totalArrows(p);
                const avg = (total && arrows>0) ? (total/arrows).toFixed(1) : '‚Äî';
                const title = (p.name && p.name!=='Unidentified Practice') ? p.name : (p.distance? (p.distance+'m') : 'Unknown target') + (p.ends? (' ‚Ä¢ '+p.ends+' ends') : '');

                // Determine target dot color
                let dotClass = 'red';
                if(avg>=8) dotClass='green';
                else if(avg>=6) dotClass='yellow';

                const card = document.createElement('div');
                card.className='session-card';
                card.innerHTML = `
                    <div class="left-stripe ${/vegas/i.test(p.name)?'stripe-yellow':/s3da|indoor/i.test(p.name)?'stripe-blue':'stripe-gray'}"></div>
                    <div class="content">
                        <div class="score-title"><span class="target-dot ${dotClass}"></span>${title} ${pb===total?'<span class="pb-badge">PB</span>':''}</div>
                        <div class="meta"><span style="margin-right:.6rem">üìÖ ${new Date(p.created).toLocaleDateString()}</span> Avg: <strong style="color:var(--accent)">${avg}</strong></div>
                    </div>
                    <div class="score">${total||'<span class="text-muted">‚Äî</span>'}
                        <div class="dropdown" style="position:absolute;top:0;right:0">
                            <button class="btn btn-sm btn-link dropdown-toggle p-0" type="button" data-bs-toggle="dropdown" style="color:var(--accent);text-decoration:none">‚ãÆ</button>
                            <ul class="dropdown-menu dropdown-menu-end">
                                <li><a class="dropdown-item edit-scores" href="#" data-id="${p.id}">Edit scores</a></li>
                                <li><a class="dropdown-item edit-details" href="#" data-id="${p.id}">Edit details</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item text-danger delete-session" href="#" data-id="${p.id}">Delete</a></li>
                            </ul>
                        </div>
                    </div>
                `;
                card.addEventListener('click', e=>{ if(e.target.closest('.dropdown')) return; window.location.href='practice_detail.html?id='+p.id; });
                card.querySelector('.edit-scores').addEventListener('click', e=>{ e.preventDefault(); window.location.href='score_entry_setup.html?id='+p.id; });
                card.querySelector('.edit-details').addEventListener('click', e=>{ e.preventDefault(); window.location.href='practice_detail.html?id='+p.id+'&edit=details'; });
                card.querySelector('.delete-session').addEventListener('click', e=>{ e.preventDefault(); if(confirm('Are you sure you want to delete this session?')){ const practices = getPractices().filter(x=>x.id!==p.id); localStorage.setItem('practices',JSON.stringify(practices)); renderScores(); } });
                container.appendChild(card);
            });
            document.querySelector('.result-count').textContent = filtered.length+' Results';

            // Hide splash after scores render
            splash.style.opacity = '0';
            setTimeout(()=>{ splash.style.display='none'; }, 600);
        }

        const state={round:'',bow:'',sort:'dateDesc'};

        function buildMenu(type){
            const container=document.getElementById('pillMenuContainer'); container.innerHTML='';
            const list=getPractices();
            if(type==='round'){
                const names=Array.from(new Set(list.map(p=>p.name||'Unknown'))).filter(Boolean);
                names.forEach(n=>{ const btn=document.createElement('button'); btn.className='pill'; btn.style.marginRight='.4rem'; btn.textContent=n; btn.addEventListener('click',()=>{ state.round=n==='All Rounds'?'':n; document.getElementById('pillRounds').textContent=n==='All Rounds'?'All Rounds':n; container.style.display='none'; renderScores(); }); container.appendChild(btn); });
                const btnAll=document.createElement('button'); btnAll.className='pill active'; btnAll.textContent='All Rounds'; btnAll.addEventListener('click',()=>{ state.round=''; document.getElementById('pillRounds').textContent='All Rounds'; container.style.display='none'; renderScores(); }); container.insertBefore(btnAll, container.firstChild);
            } else if(type==='bow'){
                const bowsFromPractices=Array.from(new Set(list.map(p=>(p.equipmentSetup&&p.equipmentSetup.bow)||(p.sessionEquipment&&p.sessionEquipment.bow)||''))).filter(x=>x);
                const equipmentSetups=JSON.parse(localStorage.getItem('equipmentSetups')||'[]');
                const bowsFromSetups=equipmentSetups.filter(s=>s.type==='bow').map(s=>s.name);
                const bows=Array.from(new Set([...bowsFromPractices,...bowsFromSetups])).filter(x=>x);
                bows.forEach(b=>{ const btn=document.createElement('button'); btn.className='pill'; btn.style.marginRight='.4rem'; btn.textContent=b; btn.addEventListener('click',()=>{ state.bow=b; document.getElementById('pillBows').textContent=b; container.style.display='none'; renderScores(); }); container.appendChild(btn); });
                const btnAll=document.createElement('button'); btnAll.className='pill active'; btnAll.textContent='All Bows'; btnAll.addEventListener('click',()=>{ state.bow=''; document.getElementById('pillBows').textContent='All Bows'; container.style.display='none'; renderScores(); }); container.insertBefore(btnAll, container.firstChild);
            }
            container.style.display='block';
        }

        document.getElementById('pillRounds').addEventListener('click',()=>{ const c=document.getElementById('pillMenuContainer'); c.style.display==='block'?c.style.display='none':buildMenu('round'); });
        document.getElementById('pillBows').addEventListener('click',()=>{ const c=document.getElementById('pillMenuContainer'); c.style.display==='block'?c.style.display='none':buildMenu('bow'); });
        document.getElementById('pillSort').addEventListener('click',()=>{ 
            if(state.sort==='dateDesc'){ state.sort='dateAsc'; document.getElementById('pillSort').textContent='Sort by: Date ‚ñ≤'; }
            else if(state.sort==='dateAsc'){ state.sort='avgDesc'; document.getElementById('pillSort').textContent='Sort by: Avg ‚ñæ'; }
            else { state.sort='dateDesc'; document.getElementById('pillSort').textContent='Sort by: Date'; }
            renderScores();
        });

        renderScores();
    })();
    </script>

</body>
</html>