<!doctype html>
<html lang="en">
<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<title>Equipment Setup</title>
	<link rel="stylesheet" href="style.css">
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
</head>

<body>
	<!-- Top-left back button: tries history.back(), falls back to index.html -->
	<a class="back-btn" href="index.html" onclick="if(history.length>1){history.back();return false;}">‚Üê Back</a>
	<nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-bottom">
    <div class="container-fluid">
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="nav nav-pills ms-auto" role="tablist">
          <li class="nav-item"><a class="nav-link" href="index.html"><span class="nav-icon">üìà</span>History</a></li>
          <li class="nav-item"><a class="nav-link" href="AI_Coach.html"><span class="nav-icon">ü§ñ</span>AI Coach</a></li>
          <li class="nav-item"><a class="nav-link active" href="equipment.html"><span class="nav-icon">üèπ</span>Equipment</a></li>
          <li class="nav-item"><a class="nav-link" href="statistics.html"><span class="nav-icon">üìä</span>Statistics</a></li>
          <li class="nav-item"><a class="nav-link" href="competition.html"><span class="nav-icon">üèÜ</span>Competition</a></li>
          <li class="nav-item"><a class="nav-link" href="menu.html"><span class="nav-icon">‚ò∞</span>Menu</a></li>
        </ul>
      </div>
    </div>
  </nav>
	<header class="page-header">
		<div class="container">
			<img src="images/AIchery_logo_full_sized.png" alt="AIchery Logo" style="max-width: 150px; height: auto;">
		</div>
	</header>
	<main class="container py-4">
		<h2>Equipment Setup</h2>
		<!-- Page purpose: create and persist equipment setups (arrows, sight, bow)
		     Saved setups stored in localStorage under key 'equipmentSetups'.
		     Edit the UI templates below to add/remove fields. -->
		<p class="text-muted">Create and save equipment setups for quick use.</p>

		<!-- Buttons to choose equipment category -->
		<div class="d-flex gap-2 mb-3 flex-wrap">
			<button id="btnArrows" class="btn btn-outline-primary flex-grow-1">Arrows</button>
			<button id="btnSight" class="btn btn-outline-primary flex-grow-1">Sight</button>
			<button id="btnBow" class="btn btn-outline-primary flex-grow-1">Bow</button>
		</div>

		<!-- Setup form: fields change depending on selected type -->
		<div id="setupCard" class="card p-3 mb-3">
			<div class="mb-2">
				<label class="form-label">Setup name</label>
				<input id="setupName" class="form-control" placeholder="e.g. Outdoor 70m - Recurve" />
			</div>

			<form id="setupForm">
				<!-- Dynamic fields inserted here -->
				<div id="dynamicFields"></div>
			</form>

			<div class="mt-3 d-flex gap-2 flex-column flex-sm-row">
				<button id="saveEquipment" class="btn btn-success flex-grow-1">Save Equipment</button>
				<button id="previewSetup" class="btn btn-secondary flex-grow-1">Preview</button>
				<button id="clearSetup" class="btn btn-outline-danger flex-grow-1">Clear</button>
			</div>
		</div>

		<!-- Preview / saved list -->
			<div class="row g-3">
				<div class="col-12">
					<h5>Saved Equipment</h5>
					<ul id="savedList" class="list-group"></ul>
				</div>
				<div class="col-12">
					<h5>Preview</h5>
					<pre id="preview" class="p-2 bg-light border" style="white-space:pre-wrap"></pre>
				</div>
			</div>

			<!-- Section: Setups (bow + sight + arrows) (Collapsible) -->
			<div class="card mt-3">
				<div class="card-header p-3 cursor-pointer" data-bs-toggle="collapse" data-bs-target="#setupsCollapse">
					<h5 class="mb-0" style="cursor:pointer">üéØ Combined Setups (Bow + Sight + Arrows)</h5>
				</div>
				<div id="setupsCollapse" class="collapse show" data-bs-parent=".site-main">
					<div class="card-body p-3">
				<div class="row g-2 align-items-center">
					<div class="col-12"><label class="form-label">Bow</label><select id="combo_bow" class="form-select"></select></div>
					<div class="col-12"><label class="form-label">Sight</label><select id="combo_sight" class="form-select"></select></div>
					<div class="col-12"><label class="form-label">Arrows</label><select id="combo_arrows" class="form-select"></select></div>
					<div class="col-12 mt-2 d-flex gap-2 flex-column flex-sm-row">
						<input id="comboName" class="form-control" placeholder="Setup name (e.g. 'Competition Setup')" />
						<button id="saveCombo" class="btn btn-primary">Save Setup</button>
					</div>
				</div>
				<div class="mt-3">
					<h6>Saved Setups</h6>
					<ul id="savedCombos" class="list-group"></ul>
				</div>
					</div>
				</div>
			</div>

	</main>

	<!-- Bottom navigation: mirror other pages for consistent navigation -->
	<nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-bottom">
    <div class="container-fluid">
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="nav nav-pills ms-auto" role="tablist">
          <li class="nav-item"><a class="nav-link" href="index.html"><span class="nav-icon">üìà</span>History</a></li>
          <li class="nav-item"><a class="nav-link" href="AI_Coach.html"><span class="nav-icon">ü§ñ</span>AI Coach</a></li>
          <li class="nav-item"><a class="nav-link active" href="equipment.html"><span class="nav-icon">üèπ</span>Equipment</a></li>
		  <li class="nav-item"><a class="nav-link" href="statistics.html"><span class="nav-icon">üìä</span>Statistics</a></li>
          <li class="nav-item"><a class="nav-link" href="competition.html"><span class="nav-icon">üèÜ</span>Competition</a></li>
          <li class="nav-item"><a class="nav-link" href="menu.html"><span class="nav-icon">‚ò∞</span>Menu</a></li>
        </ul>
      </div>
    </div>
  </nav>

	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
	<script>
	/*
	 JS: handles dynamic UI for arrows, sight, and bow setups.
	 - Saved setups are stored in localStorage key 'equipmentSetups' as an array.
	 - Each setup object: { id, name, type, data }
	 - To extend fields, edit the HTML templates in showArrows/showSight/showBow
	 - Keep names for inputs in '[name="..."]' so gatherData() can read them.
	*/
	(function(){
		const btnArrows = document.getElementById('btnArrows');
		const btnSight = document.getElementById('btnSight');
		const btnBow = document.getElementById('btnBow');
		const dynamic = document.getElementById('dynamicFields');
		const saveBtn = document.getElementById('saveEquipment');
		const previewBtn = document.getElementById('previewSetup');
		const clearBtn = document.getElementById('clearSetup');
		const savedList = document.getElementById('savedList');
		const preview = document.getElementById('preview');
		const setupName = document.getElementById('setupName');

		// Get equipment mode (simple vs advanced)
		const equipmentMode = localStorage.getItem('equipmentMode') || 'simple';

		let currentType = 'arrows';

		// Helpers for storage
		function getSetups(){ return JSON.parse(localStorage.getItem('equipmentSetups')||'[]'); }
		function saveSetups(arr){ localStorage.setItem('equipmentSetups', JSON.stringify(arr)); }

		// Render saved setups
		function renderSaved(){ savedList.innerHTML=''; const arr=getSetups(); arr.forEach(s=>{ const li=document.createElement('li'); li.className='list-group-item d-flex justify-content-between align-items-start'; li.innerHTML = `<div><strong>${s.name}</strong><div class="small text-muted">${s.type}</div></div><div class="btn-group btn-group-sm"><button data-id="${s.id}" class="btn btn-outline-primary load">Load</button><button data-id="${s.id}" class="btn btn-outline-danger del">Delete</button></div>`; savedList.appendChild(li); });
				// hook events
				Array.from(savedList.querySelectorAll('.load')).forEach(b=>b.addEventListener('click',e=>{ const id=Number(e.target.dataset.id); const s=getSetups().find(x=>x.id===id); if(s){ loadSetup(s); preview.textContent = JSON.stringify(s, null, 2); // highlight selection
					Array.from(savedList.children).forEach(li=>li.classList.remove('active'));
					e.target.closest('li').classList.add('active'); } }));
				Array.from(savedList.querySelectorAll('.del')).forEach(b=>b.addEventListener('click',e=>{ const id=Number(e.target.dataset.id); const arr=getSetups().filter(x=>x.id!==id); saveSetups(arr); renderSaved(); }));
		}

		// Build field templates per type
		function showArrows(){
			currentType='arrows';
			setActiveTypeButton('arrows');
			dynamic.innerHTML = `
				<!-- Arrow fields: length, fletch type, fletch count, material, diameter, spine, weight -->
				<div class="row g-2">
					<div class="col-6"><label class="form-label">Length (in)</label><input name="length" class="form-control" type="number" step="0.1"/></div>
					<div class="col-6"><label class="form-label">Fletch Type</label><input name="fletchType" class="form-control" placeholder="e.g. plastic vanes"/></div>
					<div class="col-6"><label class="form-label">Fletch Count</label><input name="fletchCount" class="form-control" type="number"/></div>
					<div class="col-6"><label class="form-label">Material</label>
						<select name="material" class="form-select">
							<option value="fiberglass">Fiberglass</option>
							<option value="carbon">Carbon</option>
							<option value="aluminum">Aluminum</option>
							<option value="wood">Wood</option>
							<option value="custom">Custom</option>
						</select>
					</div>
					<div class="col-6"><label class="form-label">Diameter (in)</label><input name="diameter" class="form-control" type="number" step="0.01"/></div>
					<div class="col-6"><label class="form-label">Spine</label><input name="spine" class="form-control" placeholder="e.g. 500"/></div>
					<div class="col-6"><label class="form-label">Weight (gr)</label><input name="weight" class="form-control" type="number" step="0.1"/></div>
				</div>`;
		}

		function showBow(){
			currentType='bow';
			setActiveTypeButton('bow');
			
			if(equipmentMode === 'simple'){
				// Simple mode: bow type and sight type only
				dynamic.innerHTML = `
					<div class="row g-2">
						<div class="col-12"><label class="form-label">Bow Type</label>
							<select name="bowType" class="form-select">
								<option value="">Select bow type</option>
								<option value="recurve">Recurve</option>
								<option value="compound">Compound</option>
							</select>
						</div>
						<div class="col-12"><label class="form-label">Sight Type</label>
							<select name="sightType" class="form-select">
								<option value="">Select sight style</option>
								<option value="single-pin">Single Pin</option>
								<option value="multi-pin">Multi Pin</option>
								<option value="slider">Slider</option>
							</select>
						</div>
					</div>`;
			} else {
				// Advanced mode: full form
				dynamic.innerHTML = `
					<div class="row g-2">
						<div class="col-6"><label class="form-label">Bow Type</label>
							<select name="bowType" class="form-select">
								<option value="">Select bow type</option>
								<option value="recurve">Recurve</option>
								<option value="compound">Compound</option>
							</select>
						</div>
						<div id="recurveSubType" class="col-6" style="display:none">
							<label class="form-label">Recurve Style</label>
							<select name="recurveStyle" class="form-select">
								<option value="">Select style</option>
								<option value="barebow">Barebow</option>
								<option value="olympic">Olympic</option>
							</select>
						</div>
						<div class="col-6"><label class="form-label">Draw Weight (lbs)</label><input name="drawWeight" class="form-control" type="number"/></div>
						<div class="col-6"><label class="form-label">Riser Length (in)</label><input name="riserLength" class="form-control" type="number" step="0.1"/></div>
						<div class="col-6"><label class="form-label">Limb Material/Type</label><input name="limbMaterial" class="form-control" placeholder="e.g., Carbon, Wood"/></div>
						<div class="col-6"><label class="form-label">String Replaced Date</label><input name="replacedStringDate" class="form-control" placeholder="MM/DD/YYYY"/></div>
						
						<!-- Barebow specific fields (hidden by default) -->
						<div id="barebowToggle" class="col-12" style="display:none">
							<div class="form-check form-switch">
								<input class="form-check-input" type="checkbox" name="barebowNoAccessories" id="barebowNoAccessories">
								<label class="form-check-label" for="barebowNoAccessories">Barebow (disable accessories)</label>
							</div>
						</div>
						
						<!-- Olympic/Compound sight & stabilizer fields (hidden by default) -->
						<div id="sightFields" class="col-12" style="display:none">
							<label class="form-label">Sight Type</label><input name="sightType" class="form-control" placeholder="e.g., Single-pin, Multi-pin"/>
						</div>
						<div id="stabilizerFields" class="col-12" style="display:none">
							<label class="form-label">Stabilizer Length (in)</label><input name="stabilizerLength" class="form-control" type="number" step="0.1"/>
						</div>
						
						<!-- Compound specific fields (hidden by default) -->
						<div id="compoundFields" class="col-12" style="display:none">
							<div class="row g-2">
								<div class="col-6"><label class="form-label">Cam Type</label><input name="camType" class="form-control" placeholder="e.g., Single, Dual, Hybrid"/></div>
								<div class="col-6"><label class="form-label">Let Off (%)</label><input name="letOff" class="form-control" type="number" min="0" max="100"/></div>
								<div class="col-6"><label class="form-label">Draw Length (in)</label><input name="drawLength" class="form-control" type="number" step="0.125"/></div>
								<div class="col-6"><label class="form-label">Bow Weight (lbs)</label><input name="bowWeight" class="form-control" type="number" step="0.1"/></div>
								<div class="col-6"><label class="form-label">Axle to Axle (in)</label><input name="axleToAxle" class="form-control" type="number" step="0.1"/></div>
								<div class="col-6"><label class="form-label">Brace Height (in)</label><input name="braceHeight" class="form-control" type="number" step="0.1"/></div>
							</div>
						</div>
						
						<div class="col-12"><label class="form-label">Notes</label><textarea name="bowNotes" class="form-control" rows="2"></textarea></div>
					</div>`;
				
				// Attach event listeners for advanced mode
				setTimeout(() => {
					const bowTypeSelect = dynamic.querySelector('[name="bowType"]');
					const recurveStyleSelect = dynamic.querySelector('[name="recurveStyle"]');
					const barebowToggle = document.getElementById('barebowToggle');
					const barebowNoAccessoriesCheckbox = document.getElementById('barebowNoAccessories');
					const sightFields = document.getElementById('sightFields');
					const stabilizerFields = document.getElementById('stabilizerFields');
					const compoundFields = document.getElementById('compoundFields');
					const recurveSubType = document.getElementById('recurveSubType');
					
					function updateBowFields() {
						const bowType = bowTypeSelect.value;
						const recurveStyle = recurveStyleSelect.value;
						
						// Reset visibility
						recurveSubType.style.display = 'none';
						barebowToggle.style.display = 'none';
						sightFields.style.display = 'none';
						stabilizerFields.style.display = 'none';
						compoundFields.style.display = 'none';
						
						if (bowType === 'recurve') {
							recurveSubType.style.display = 'block';
							
							if (recurveStyle === 'barebow') {
								barebowToggle.style.display = 'block';
							} else if (recurveStyle === 'olympic') {
								sightFields.style.display = 'block';
								stabilizerFields.style.display = 'block';
							}
						} else if (bowType === 'compound') {
							sightFields.style.display = 'block';
							stabilizerFields.style.display = 'block';
							compoundFields.style.display = 'block';
						}
					}
					
					bowTypeSelect.addEventListener('change', updateBowFields);
					recurveStyleSelect.addEventListener('change', updateBowFields);
				}, 0);
			}
		}

		function showSight(){
			currentType='sight';
			setActiveTypeButton('sight');
			
			if(equipmentMode === 'simple'){
				// Simple mode: sight type only
				dynamic.innerHTML = `
					<div class="row g-2">
						<div class="col-12"><label class="form-label">Sight Type</label>
							<select name="sightType" class="form-select">
								<option value="">Select sight style</option>
								<option value="fixed">Fixed</option>
								<option value="slider">Slider</option>
							</select>
						</div>
					</div>`;
			} else {
				// Advanced mode: hierarchical sight configuration
				dynamic.innerHTML = `
					<div class="row g-2">
						<!-- Sight Type: Fixed or Slider -->
						<div class="col-12">
							<label class="form-label">Sight Type</label>
							<select id="sightType" class="form-select">
								<option value="fixed">Fixed</option>
								<option value="slider">Slider</option>
							</select>
						</div>
						
						<!-- Pin Configuration: Single or Multi (only for Slider) -->
						<div id="pinConfigDiv" class="col-12" style="display:none;">
							<label class="form-label">Pin Configuration</label>
							<select id="pinConfiguration" class="form-select">
								<option value="single">Single Pin</option>
								<option value="multi">Multi-Pin</option>
							</select>
						</div>
						
						<!-- Additional Features: Lens, Ring, Dot -->
						<div class="col-12">
							<label class="form-label">Additional Features</label>
							<div class="form-check">
								<input type="checkbox" id="hasLens" class="form-check-input">
								<label class="form-check-label" for="hasLens">Lens</label>
							</div>
							<div class="form-check">
								<input type="checkbox" id="hasRing" class="form-check-input">
								<label class="form-check-label" for="hasRing">Ring</label>
							</div>
							<div class="form-check">
								<input type="checkbox" id="hasDot" class="form-check-input">
								<label class="form-check-label" for="hasDot">Dot</label>
							</div>
						</div>
						
						<!-- Lens Configuration Fields -->
						<div id="lensFields" class="col-12" style="display:none;">
							<label class="form-label">Lens Power</label>
							<input name="lensPower" class="form-control" placeholder="e.g. +1.5"/>
							<label class="form-label mt-2">Clarifier (optional)</label>
							<input name="clarifier" class="form-control" placeholder="e.g. clear/neutral"/>
						</div>
						
						<!-- Pins Section (Slider without Ring/Dot) -->
						<div id="pinsSection" class="col-12" style="display:none;">
							<label class="form-label">Pin Configuration</label>
							<div id="pinsContainer"></div>
							<div class="mt-2"><button id="addPin" type="button" class="btn btn-sm btn-outline-primary">Add Pin</button></div>
						</div>
					</div>

					<!-- hidden template for each pin line -->
					<template id="pinTpl">
						<div class="d-flex gap-2 align-items-center pin-line mb-2">
							<select name="pinColor" class="form-select form-select-sm" style="width:120px">
								<option value="#FF0000">Red</option>
								<option value="#FFA500">Orange</option>
								<option value="#FF8C00">Red-Orange</option>
								<option value="#00FF00">Green</option>
							</select>
							<input name="pinDistance" class="form-control form-control-sm" type="number" placeholder="Distance (yd)" />
							<button type="button" class="btn btn-sm btn-outline-danger remove-pin">Remove</button>
						</div>
					</template>`;

				// Set up hierarchical sight configuration logic
				setTimeout(()=>{
					const sightType = document.getElementById('sightType');
					const pinConfigDiv = document.getElementById('pinConfigDiv');
					const pinConfiguration = document.getElementById('pinConfiguration');
					const hasLens = document.getElementById('hasLens');
					const hasRing = document.getElementById('hasRing');
					const hasDot = document.getElementById('hasDot');
					const lensFields = document.getElementById('lensFields');
					const pinsSection = document.getElementById('pinsSection');
					
					function updateFieldsVisibility(){
						// Show pin configuration only for slider type
						pinConfigDiv.style.display = (sightType.value === 'slider') ? 'block' : 'none';
						
						// Show pins section only if: Slider type, AND neither Ring nor Dot is selected
						const showPins = (sightType.value === 'slider') && !hasRing.checked && !hasDot.checked;
						pinsSection.style.display = showPins ? 'block' : 'none';
						
						// Show lens fields only if Lens checkbox is checked
						lensFields.style.display = hasLens.checked ? 'block' : 'none';
					}
					
					sightType.addEventListener('change', updateFieldsVisibility);
					pinConfiguration.addEventListener('change', updateFieldsVisibility);
					hasLens.addEventListener('change', updateFieldsVisibility);
					hasRing.addEventListener('change', updateFieldsVisibility);
					hasDot.addEventListener('change', updateFieldsVisibility);
					
					updateFieldsVisibility();
					document.getElementById('addPin').addEventListener('click', addPin);
				},0);
			}
		}

		function setActiveTypeButton(type){
			['arrows','sight','bow'].forEach(t=>{
				const btn = t==='arrows'?btnArrows:(t==='sight'?btnSight:btnBow);
				if(!btn) return;
				btn.classList.toggle('active', t===type);
			});
		}

		// Add a new pin entry to the pinsContainer. Each pin records color + distance.
		function addPin(){
			const tpl = document.getElementById('pinTpl');
			const node = tpl.content.cloneNode(true);
			const container=document.getElementById('pinsContainer');
			container.appendChild(node);
			container.querySelectorAll('.remove-pin').forEach(b=>b.addEventListener('click',e=>e.target.closest('.pin-line').remove()));
		}

		// Load a saved setup into the UI for editing
		function loadSetup(s){ setupName.value = s.name || ''; if(s.type==='arrows'){ showArrows(); setTimeout(()=>{ Object.keys(s.data||{}).forEach(k=>{ const el = dynamic.querySelector('[name="'+k+'"]'); if(el) el.value = s.data[k]; }); },0); }
		if(s.type==='sight'){ showSight(); setTimeout(()=>{ const d=s.data||{}; 
			document.getElementById('sightType').value = d.sightType || 'fixed';
			document.getElementById('pinConfiguration').value = d.pinConfiguration || 'single';
			document.getElementById('hasLens').checked = d.hasLens || false;
			document.getElementById('hasRing').checked = d.hasRing || false;
			document.getElementById('hasDot').checked = d.hasDot || false;
			if(d.hasLens){ 
				dynamic.querySelector('[name="lensPower"]').value = d.lensPower||''; 
				dynamic.querySelector('[name="clarifier"]').value = d.clarifier||''; 
			}
			// load pins if slider type without ring/dot
			if(d.sightType === 'slider' && !d.hasRing && !d.hasDot){
				(d.pins||[]).forEach(p=>{ addPin(); const pc = document.getElementById('pinsContainer'); const last = pc.querySelector('.pin-line:last-child'); last.querySelector('[name="pinColor"]').value = p.color||'#000000'; last.querySelector('[name="pinDistance"]').value = p.distance||''; });
			}
			// trigger visibility update
			const evt = new Event('change', {bubbles:true});
			document.getElementById('sightType').dispatchEvent(evt);
		},0); }
				if(s.type==='bow'){ showBow(); setTimeout(()=>{ const d=s.data||{}; Object.keys(d).forEach(k=>{ const el = dynamic.querySelector('[name="'+k+'"]'); if(k==='barebowNoAccessories' && el) el.checked = d[k]; else if(el) el.value = d[k]; }); const bowTypeSelect = dynamic.querySelector('[name="bowType"]'); const recurveStyleSelect = dynamic.querySelector('[name="recurveStyle"]'); if(bowTypeSelect && recurveStyleSelect) { const evt = new Event('change', {bubbles:true}); bowTypeSelect.dispatchEvent(evt); } },0); }
		}

		// gather form data depending on type
		function gatherData(){ const data={}; if(currentType==='arrows'){ ['length','fletchType','fletchCount','material','diameter','spine','weight'].forEach(n=>{ const el = dynamic.querySelector('[name="'+n+'"]'); if(el) data[n]=el.value; }); }
			else if(currentType==='bow'){ ['bowType','recurveStyle','drawWeight','riserLength','limbMaterial','bowNotes','replacedStringDate','sightType','stabilizerLength','barebowNoAccessories','camType','letOff','drawLength','bowWeight','axleToAxle','braceHeight'].forEach(n=>{ const barebowCheck = dynamic.querySelector('[name="barebowNoAccessories"]'); if(n==='barebowNoAccessories' && barebowCheck) data[n] = barebowCheck.checked; else { const el = dynamic.querySelector('[name="'+n+'"]'); if(el) data[n]=el?el.value:''; } }); }
			else if(currentType==='sight'){ 
				data.sightType = dynamic.querySelector('#sightType')?.value || 'fixed';
				data.pinConfiguration = dynamic.querySelector('#pinConfiguration')?.value || 'single';
				data.hasLens = dynamic.querySelector('#hasLens')?.checked || false;
				data.hasRing = dynamic.querySelector('#hasRing')?.checked || false;
				data.hasDot = dynamic.querySelector('#hasDot')?.checked || false;
				if(data.hasLens){ 
					data.lensPower = dynamic.querySelector('[name="lensPower"]')?.value; 
					data.clarifier = dynamic.querySelector('[name="clarifier"]')?.value; 
				}
				// only save pins if slider without ring/dot
				if(data.sightType === 'slider' && !data.hasRing && !data.hasDot){
					data.pins = Array.from(dynamic.querySelectorAll('.pin-line')).map(pl=>({ color: pl.querySelector('[name="pinColor"]').value, distance: pl.querySelector('[name="pinDistance"]').value })); 
				} else {
					data.pins = [];
				}
			}
			return data; }


		// Validation: ensure numeric fields are realistic
		function clearFieldErrors(){ Array.from(dynamic.querySelectorAll('.field-error')).forEach(e=>e.remove()); }
		function showFieldError(el, msg){ if(!el) return; const ex = document.createElement('div'); ex.className='form-text text-danger field-error'; ex.textContent = msg; el.insertAdjacentElement('afterend', ex); }
		function validateData(data){ clearFieldErrors(); const errs = [];
			if(currentType==='arrows'){
				const length = parseFloat(data.length||0);
				if(isNaN(length) || length < 10 || length > 40){ const el = dynamic.querySelector('[name="length"]'); showFieldError(el,'Length must be 10‚Äì40 in'); errs.push('length'); }
				const fcount = parseInt(data.fletchCount||0);
				if(isNaN(fcount) || fcount < 0 || fcount > 10){ const el = dynamic.querySelector('[name="fletchCount"]'); showFieldError(el,'Fletch count 0‚Äì10'); errs.push('fletchCount'); }
				const diam = parseFloat(data.diameter||0);
				if(isNaN(diam) || diam < 0.02 || diam > 1.0){ const el = dynamic.querySelector('[name="diameter"]'); showFieldError(el,'Diameter must be 0.02‚Äì1.0 in'); errs.push('diameter'); }
				const spine = Number(data.spine||0);
				if(data.spine && (spine < 200 || spine > 1500)){ const el = dynamic.querySelector('[name="spine"]'); showFieldError(el,'Spine typically 200‚Äì1500'); errs.push('spine'); }
				const weight = parseFloat(data.weight||0);
				if(isNaN(weight) || weight < 20 || weight > 1000){ const el = dynamic.querySelector('[name="weight"]'); showFieldError(el,'Weight must be 20‚Äì1000 gr'); errs.push('weight'); }
			}
			if(currentType==='bow'){
				const riser = parseFloat(data.riserLength||0);
				if(isNaN(riser) || riser < 8 || riser > 40){ const el = dynamic.querySelector('[name="riserLength"]'); showFieldError(el,'Riser length must be 8‚Äì40 in'); errs.push('riserLength'); }
				const draw = parseFloat(data.drawWeight||0);
				if(isNaN(draw) || draw < 12 || draw > 80){ const el = dynamic.querySelector('[name="drawWeight"]'); showFieldError(el,'Draw weight must be 12‚Äì80 lbs'); errs.push('drawWeight'); }
				// Compound-specific validation
				if(data.bowType === 'compound'){
					const letoff = parseFloat(data.letOff||0);
					if(data.letOff && (isNaN(letoff) || letoff < 0 || letoff > 100)){ const el = dynamic.querySelector('[name="letOff"]'); showFieldError(el,'Let off must be 0‚Äì100%'); errs.push('letOff'); }
					const drawLength = parseFloat(data.drawLength||0);
					if(data.drawLength && (isNaN(drawLength) || drawLength < 15 || drawLength > 32)){ const el = dynamic.querySelector('[name="drawLength"]'); showFieldError(el,'Draw length must be 15‚Äì32 in'); errs.push('drawLength'); }
					const a2a = parseFloat(data.axleToAxle||0);
					if(data.axleToAxle && (isNaN(a2a) || a2a < 24 || a2a > 48)){ const el = dynamic.querySelector('[name="axleToAxle"]'); showFieldError(el,'Axle to axle must be 24‚Äì48 in'); errs.push('axleToAxle'); }
				}
			}
			if(currentType==='sight'){
				Array.from(dynamic.querySelectorAll('[name="pinDistance"]')).forEach(el=>{
					const v = parseFloat(el.value||0);
					if(isNaN(v) || v < 1 || v > 200){ showFieldError(el,'Pin distance must be 1‚Äì200 yd'); errs.push('pinDistance'); }
				});
			}
			return errs.length===0;
		}

		// Save setup
		saveBtn.addEventListener('click', ()=>{
			const name = setupName.value.trim() || (currentType+' equipment ' + new Date().toLocaleString());
			const data = gatherData();
			// validate
			if(!validateData(data)){
				const firstErr = dynamic.querySelector('.field-error'); if(firstErr) firstErr.previousElementSibling?.focus();
				return;
			}
			const obj = { id: Date.now(), name, type: currentType, data: data };
			const arr = getSetups(); arr.push(obj); saveSetups(arr); renderSaved();
			preview.textContent = JSON.stringify(obj, null, 2);
		});

		previewBtn.addEventListener('click', ()=>{ const obj = { name: setupName.value||'(unnamed)', type: currentType, data: gatherData() }; preview.textContent = JSON.stringify(obj, null, 2); });
		clearBtn.addEventListener('click', ()=>{ setupName.value=''; dynamic.innerHTML=''; if(currentType==='sight') showSight(); if(currentType==='arrows') showArrows(); if(currentType==='bow') showBow(); preview.textContent=''; });

		// type button handlers
		btnArrows.addEventListener('click', ()=>{ showArrows(); });
		btnSight.addEventListener('click', ()=>{ showSight(); });
		btnBow.addEventListener('click', ()=>{ showBow(); });

		// init - load pre-loaded setups if first time
		function initializeDefaultSetups(){
			const existing = getSetups();
			if(existing.length === 0){
				const defaults = [
					{
						id: 1,
						name: "Prime Ronan",
						type: "bow",
						data: {
							bowType: "compound",
							drawWeight: "55",
							riserLength: "29.5",
							limbMaterial: "Carbon",
							bowNotes: "Prime Ronan - Main bow",
							camType: "Dual",
							letOff: "80",
							drawLength: "28",
							bowWeight: "3.2",
							axleToAxle: "31.5",
							braceHeight: "6.25",
							replacedStringDate: "02/03/2026"
						}
					},
					{
						id: 2,
						name: "My Arrows",
						type: "arrows",
						data: {
							length: "30",
							fletchType: "Airrazr vanes",
							fletchCount: "4",
							material: "carbon",
							diameter: "0.25",
							spine: "",
							weight: ""
						}
					},
					{
						id: 3,
						name: "Redline RL-3",
						type: "sight",
						data: {
							sightType: "multi-pin",
							hasLens: false,
							lensPower: "",
							clarifier: "",
							pins: [
								{ color: "#FF0000", distance: "20" },
								{ color: "#FFA500", distance: "30" },
								{ color: "#FFFF00", distance: "40" },
								{ color: "#00FF00", distance: "50" }
							]
						}
					},
					{
						id: 5,
						name: "AXCEL Driver",
						type: "sight",
						data: {
							sightType: "3-pin-slider",
							hasLens: false,
							lensPower: "",
							clarifier: "",
							pins: [
								{ color: "#00FF00", distance: "20" },
								{ color: "#FF8C00", distance: "30" },
								{ color: "#00FF00", distance: "40" }
							]
						}
					},
					{
						id: 4,
						name: "Olympic Recurve",
						type: "bow",
						data: {
							bowType: "recurve",
							recurveStyle: "olympic",
							drawWeight: "48",
							riserLength: "25",
							limbMaterial: "Carbon",
							bowNotes: "Competition recurve",
							sightType: "Multi-pin",
							stabilizerLength: "24",
							replacedStringDate: ""
						}
					}
				];
				saveSetups(defaults);
			}
		}
		initializeDefaultSetups();
		
		// Migration: ensure new sights are added to existing installations
		function ensureNewSights(){
			const setups = getSetups();
			const newSights = [
				{
					id: 5,
					name: "AXCEL Driver",
					type: "sight",
					data: {
						sightType: "3-pin-slider",
						hasLens: false,
						lensPower: "",
						clarifier: "",
						pins: [
							{ color: "#00FF00", distance: "20" },
							{ color: "#FF8C00", distance: "30" },
							{ color: "#00FF00", distance: "40" }
						]
					}
				}
			];
			
			let updated = false;
			newSights.forEach(newSight => {
				if(!setups.find(s => s.id === newSight.id)){
					setups.push(newSight);
					updated = true;
				}
			});
			
			if(updated){
				saveSetups(setups);
			}
		}
		ensureNewSights();
		showArrows(); renderSaved();
			// populate combo selects and saved combos
			function getCombos(){ return JSON.parse(localStorage.getItem('setups')||'[]'); }
			function saveCombos(arr){ localStorage.setItem('setups', JSON.stringify(arr)); }

			function populateComboSelects(){ const setups = getSetups(); const bowSel=document.getElementById('combo_bow'); const sightSel=document.getElementById('combo_sight'); const arrowsSel=document.getElementById('combo_arrows'); if(!bowSel) return; bowSel.innerHTML=''; sightSel.innerHTML=''; arrowsSel.innerHTML=''; setups.forEach(s=>{ const o=document.createElement('option'); o.value=s.id; o.textContent=s.name; if(s.type==='bow') bowSel.appendChild(o); if(s.type==='sight') sightSel.appendChild(o); if(s.type==='arrows') arrowsSel.appendChild(o); }); }

			function renderCombos(){ const list=document.getElementById('savedCombos'); if(!list) return; list.innerHTML=''; const arr=getCombos(); arr.forEach(c=>{ const li=document.createElement('li'); li.className='list-group-item d-flex justify-content-between align-items-start'; li.innerHTML=`<div><strong>${c.name}</strong><div class="small text-muted">Bow:${c.bowName||'(none)'} ‚Ä¢ Sight:${c.sightName||'(none)'} ‚Ä¢ Arrows:${c.arrowsName||'(none)'}</div></div><div class="btn-group btn-group-sm"><button data-id="${c.id}" class="btn btn-outline-primary load-combo">Load</button><button data-id="${c.id}" class="btn btn-outline-danger del-combo">Delete</button></div>`; list.appendChild(li); });
				Array.from(list.querySelectorAll('.load-combo')).forEach(b=>b.addEventListener('click', e=>{ const id=Number(e.target.dataset.id); const c = getCombos().find(x=>x.id===id); if(c){ document.getElementById('comboName').value = c.name; document.getElementById('combo_bow').value = c.bowId || ''; document.getElementById('combo_sight').value = c.sightId || ''; document.getElementById('combo_arrows').value = c.arrowsId || ''; preview.textContent = JSON.stringify(c, null, 2); Array.from(list.children).forEach(li=>li.classList.remove('active')); e.target.closest('li').classList.add('active'); } }));
				Array.from(list.querySelectorAll('.del-combo')).forEach(b=>b.addEventListener('click', e=>{ const id=Number(e.target.dataset.id); const arr=getCombos().filter(x=>x.id!==id); saveCombos(arr); renderCombos(); })); }

			populateComboSelects(); renderCombos();

			// save combo handler
			document.getElementById('saveCombo')?.addEventListener('click', ()=>{
				const bowId = document.getElementById('combo_bow')?.value || null;
				const sightId = document.getElementById('combo_sight')?.value || null;
				const arrowsId = document.getElementById('combo_arrows')?.value || null;
				const name = document.getElementById('comboName')?.value.trim() || ('Setup '+ new Date().toLocaleString());
				const setups = getSetups(); const bow = setups.find(s=>String(s.id)===String(bowId)); const sight = setups.find(s=>String(s.id)===String(sightId)); const arrows = setups.find(s=>String(s.id)===String(arrowsId));
				const combo = { id: Date.now(), name, bowId: bowId, sightId: sightId, arrowsId: arrowsId, bowName: bow?.name, sightName: sight?.name, arrowsName: arrows?.name };
				const arr = getCombos(); arr.push(combo); saveCombos(arr); renderCombos(); showPreview(combo);
			});

			function showPreview(obj){ document.getElementById('preview').textContent = JSON.stringify(obj, null, 2); }
	})();
	</script>
	<script>
		// Catch unhandled button clicks and show error
		document.addEventListener('click', (e) => {
			const btn = e.target.closest('button:not([data-bs-dismiss])'); 
			if(!btn) return;
			if(btn.onclick || btn.getAttribute('onclick')) return;
			if(!btn.id && !btn.getAttribute('data-action')) {
				e.preventDefault();
				alert('This feature is not yet implemented.');
			}
		});
	</script>
</body>
</html>

